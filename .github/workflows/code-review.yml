name: Code Review - Convention Checker

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  convention-check:
    name: Check Coding Conventions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for comparison
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.swift
      
      - name: Review Swift files against conventions
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## ðŸ“‹ Coding Convention Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          ISSUES=0
          FILES="${{ steps.changed-files.outputs.all_changed_files }}"
          
          if [ -z "$FILES" ]; then
            echo "No changed files" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [ ! -f "$file" ]; then
              echo "â­ï¸ Skipping deleted file: \`$file\`" >> $GITHUB_STEP_SUMMARY
              continue
            fi
            
            echo "### Checking: \`$file\`" >> $GITHUB_STEP_SUMMARY
            
            # Check 1: One type per file (exclude comments, handle modifiers)
            TYPE_COUNT=$(grep -E '^[[:space:]]*(public|open|internal|fileprivate|private|final|@objc[[:space:]]+)?[[:space:]]*(struct|class|enum|protocol)\b' "$file" | sed '/^[[:space:]]*\/\//d' | wc -l | tr -d ' ')
            if [ "$TYPE_COUNT" -gt 1 ]; then
              echo "âŒ **Multiple types in one file** (found $TYPE_COUNT)" >> $GITHUB_STEP_SUMMARY
              ISSUES=$((ISSUES+1))
            else
              echo "âœ… One type per file" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Check 2: No short variable names (i, j, x, y) - improved regex
            if grep -n -E '\b(let|var)\s+[ijxy]\b' "$file" > /dev/null; then
              echo "âš ï¸  **Short variable names detected** (use descriptive names)" >> $GITHUB_STEP_SUMMARY
              grep -n -E '\b(let|var)\s+[ijxy]\b' "$file" | while read -r line; do
                echo "  - Line: \`$line\`" >> $GITHUB_STEP_SUMMARY
              done
              ISSUES=$((ISSUES+1))
            fi
            
            # Check 3: File length check
            LINE_COUNT=$(wc -l < "$file" | tr -d ' ')
            if [ "$LINE_COUNT" -gt 500 ]; then
              echo "âš ï¸  **File too long** ($LINE_COUNT lines, recommend < 500)" >> $GITHUB_STEP_SUMMARY
              ISSUES=$((ISSUES+1))
            fi
            
            # Check 4: Check for magic numbers (excluding test files, exclude comments)
            if [[ ! "$file" =~ [Tt]est ]]; then
              if grep -v '^\s*//' "$file" | grep -E '[^a-zA-Z0-9](10|20|100|0\.[0-9]+)[^0-9]' > /dev/null; then
                echo "âš ï¸  **Possible magic numbers detected** (consider using GameConstants)" >> $GITHUB_STEP_SUMMARY
                ISSUES=$((ISSUES+1))
              fi
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
          done <<< "$FILES"
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Total Issues Found:** $ISSUES" >> $GITHUB_STEP_SUMMARY
          
          if [ $ISSUES -eq 0 ]; then
            echo "ðŸŽ‰ **All conventions followed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“– **Review CODING_CONVENTIONS.md for guidelines**" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check for CODING_CONVENTIONS.md
        run: |
          if [ -f "CODING_CONVENTIONS.md" ]; then
            echo "âœ… Coding conventions document found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  No CODING_CONVENTIONS.md found" >> $GITHUB_STEP_SUMMARY
          fi

