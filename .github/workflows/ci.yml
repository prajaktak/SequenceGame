name: CI - Build & Test

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  test:
    runs-on: macos-15
    timeout-minutes: 30  # Prevent entire job from hanging
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 1
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
      
      - name: Show Available Simulators (Before)
        run: |
          echo "=== Xcode Version ==="
          xcodebuild -version
          echo ""
          echo "=== Available iOS Simulators (Before Runtime Install) ==="
          xcrun simctl list devices available iOS
      
      - name: Install iOS 18 Runtime
        run: |
          set -x  # Verbose logging
          echo "ðŸ” Checking current runtimes..."
          xcrun simctl list runtimes
          
          echo ""
          echo "ðŸ” Checking available devices BEFORE install..."
          xcrun simctl list devices available
          
          # Check if iOS 18 runtime already exists
          if xcrun simctl list runtimes | grep -q "iOS 18"; then
            echo "âœ… iOS 18 runtime already installed!"
            
            # Verify iPhone 16 Pro is available
            if xcrun simctl list devices available | grep -q "iPhone 16 Pro"; then
              echo "âœ… iPhone 16 Pro simulator already available!"
              exit 0
            fi
          fi
          
          echo ""
          echo "ðŸ“¥ iOS 18 runtime not found, installing..."
          echo "âš ï¸ This may take 20-40 minutes and download 10+ GB"
          echo "â° Started at: $(date)"
          
          # Method 1: Run first launch (sets up Xcode fully)
          echo "Step 1: Running Xcode first launch setup..."
          sudo xcodebuild -runFirstLaunch
          
          # Method 2: Download platform explicitly
          echo "Step 2: Downloading iOS platform..."
          sudo xcodebuild -downloadPlatform iOS 2>&1 | tee download.log
          
          # Method 3: Install available simulators
          echo "Step 3: Installing all available simulators..."
          sudo xcodebuild -downloadAllPlatforms 2>&1 | tee download_all.log || echo "downloadAllPlatforms not available"
          
          echo ""
          echo "â° Finished at: $(date)"
          
          echo ""
          echo "ðŸ” Verifying runtimes AFTER install..."
          xcrun simctl list runtimes
          
          echo ""
          echo "ðŸ” Checking devices AFTER install..."
          xcrun simctl list devices available
          
          # Verify iOS 18 is installed
          if ! xcrun simctl list runtimes | grep -q "iOS 18"; then
            echo "âŒ iOS 18 runtime STILL not found after all attempts!"
            echo ""
            echo "Available runtimes:"
            xcrun simctl list runtimes
            echo ""
            echo "Download log contents:"
            cat download.log || echo "No download.log"
            exit 1
          fi
          
          # Verify iPhone 16 Pro exists
          if ! xcrun simctl list devices available | grep -q "iPhone 16 Pro"; then
            echo "âš ï¸ iPhone 16 Pro not found, but iOS 18 runtime exists"
            echo "Creating iPhone 16 Pro device..."
            
            # Get iOS 18 runtime identifier
            IOS_18_RUNTIME=$(xcrun simctl list runtimes | grep "iOS 18" | head -1 | grep -oE 'com\.apple\.CoreSimulator\.SimRuntime\.[^ ]+')
            echo "Using runtime: $IOS_18_RUNTIME"
            
            # Create iPhone 16 Pro device
            xcrun simctl create "iPhone 16 Pro" "com.apple.CoreSimulator.SimDeviceType.iPhone-16-Pro" "$IOS_18_RUNTIME" || echo "Failed to create device"
          fi
          
          echo ""
          echo "ðŸ” Final device list:"
          xcrun simctl list devices available | grep "iPhone 16 Pro" || {
            echo "âŒ Still no iPhone 16 Pro available!"
            echo "Available iPhones:"
            xcrun simctl list devices available | grep "iPhone"
            exit 1
          }
          
          echo "âœ… iOS 18 runtime and iPhone 16 Pro verified!"
        timeout-minutes: 60
      
      - name: Show Available Simulators (After)
        run: |
          echo "=== Available iOS Simulators (After Runtime Install) ==="
          xcrun simctl list devices available iOS
          echo ""
          echo "=== All Installed Runtimes ==="
          xcrun simctl list runtimes
      
      - name: Install SwiftLint
        run: |
          if ! command -v swiftlint &> /dev/null; then
            echo "Installing SwiftLint..."
            brew install swiftlint
          else
            echo "SwiftLint already installed: $(swiftlint version)"
          fi
      
      - name: Run SwiftLint
        run: |
          cd SequenceGame
          swiftlint lint --strict || echo "âš ï¸ SwiftLint found issues, but continuing..."
        continue-on-error: true
      
      - name: Boot Simulator and Set Destination
        id: simulator
        run: |
          echo "=== Finding and booting iOS Simulator ==="
          
          # Debug: Show all available devices
          echo "=== All Available Devices ==="
          xcrun simctl list devices available | head -20
          
          # Find first available iPhone simulator (simplest approach)
          SIMULATOR_NAME=$(xcrun simctl list devices available | grep -i "iPhone" | head -1 | awk -F'(' '{print $1}' | xargs)
          
          if [ -z "$SIMULATOR_NAME" ]; then
            echo "âŒ No iPhone simulators found!"
            echo "Available devices:"
            xcrun simctl list devices available
            exit 1
          fi
          
          echo "ðŸ“± Found simulator: '$SIMULATOR_NAME'"
          
          # Boot the simulator (idempotent)
          echo "ðŸ“± Booting '$SIMULATOR_NAME'..."
          BOOT_OUTPUT=$(xcrun simctl boot "$SIMULATOR_NAME" 2>&1) || echo "Boot output: $BOOT_OUTPUT"
          
          # Wait for boot and verify
          echo "â³ Waiting for simulator to be ready..."
          sleep 5
          
          # Verify simulator is booted
          BOOT_STATUS=$(xcrun simctl list devices | grep "$SIMULATOR_NAME" | grep -oE "\([^)]+\)" | head -1)
          echo "ðŸ“± Simulator status: $BOOT_STATUS"
          
          echo "simulator_name=$SIMULATOR_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Using simulator: '$SIMULATOR_NAME'"
      
      - name: Run Unit Tests
        run: |
          DESTINATION="platform=iOS Simulator,name=${{ steps.simulator.outputs.simulator_name }}"
          echo "Using destination: $DESTINATION"
          set -o pipefail
          
          # Try build-for-testing + test-without-building first (more reliable for Swift Testing)
          echo "Building test bundle..."
          xcodebuild clean build-for-testing \
            -project SequenceGame/SequenceGame.xcodeproj \
            -scheme SequenceGame \
            -destination "$DESTINATION" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            2>&1 | tee build.log
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "âœ… Build successful, running tests..."
            xcodebuild test-without-building \
              -project SequenceGame/SequenceGame.xcodeproj \
              -scheme SequenceGame \
              -destination "$DESTINATION" \
              -only-testing:SequenceGameTests \
              -resultBundlePath TestResults.xcresult \
              -enableCodeCoverage YES \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              2>&1 | tee test.log || {
                echo "âŒ Unit tests failed"
                echo "Last 50 lines of test.log:"
                tail -50 test.log
                exit 1
              }
          else
            echo "âš ï¸ build-for-testing failed (exit code: $BUILD_EXIT_CODE), trying simple 'test' command..."
            echo "Build log (last 30 lines):"
            tail -30 build.log
            echo ""
            echo "Trying fallback: clean build test (per GitHub docs)..."
            # Fallback: simple approach per https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift
            xcodebuild clean build test \
              -project SequenceGame/SequenceGame.xcodeproj \
              -scheme SequenceGame \
              -destination "$DESTINATION" \
              -only-testing:SequenceGameTests \
              -resultBundlePath TestResults.xcresult \
              -enableCodeCoverage YES \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              2>&1 | tee test.log || {
                echo "âŒ Unit tests failed with fallback method too"
                echo "Last 50 lines of test.log:"
                tail -50 test.log
                exit 1
              }
          fi
        timeout-minutes: 15
      
      - name: Run UI Tests
        run: |
          DESTINATION="platform=iOS Simulator,name=${{ steps.simulator.outputs.simulator_name }}"
          echo "Using destination: $DESTINATION"
          set -o pipefail
          xcodebuild clean build test \
            -project SequenceGame/SequenceGame.xcodeproj \
            -scheme SequenceGame \
            -destination "$DESTINATION" \
            -only-testing:SequenceGameUITests \
            -resultBundlePath UITestResults.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            2>&1 | tee ui_test.log || {
              echo "âš ï¸ UI tests failed (continuing due to continue-on-error)"
              tail -50 ui_test.log
            }
        timeout-minutes: 20
        continue-on-error: true  # UI tests can be flaky in CI
      
      - name: Parse Test Results
        if: failure()
        run: |
          echo "## Test Failure Summary" > test_summary.md
          echo "" >> test_summary.md
          
          if [ -f test.log ]; then
            echo "### Unit Test Failures:" >> test_summary.md
            grep -E "error:|failed|Test Case.*failed" test.log | head -20 >> test_summary.md || echo "No unit test failures parsed" >> test_summary.md
          fi
          
          if [ -f ui_test.log ]; then
            echo "" >> test_summary.md
            echo "### UI Test Failures:" >> test_summary.md
            grep -E "error:|failed|Test Case.*failed" ui_test.log | head -20 >> test_summary.md || echo "No UI test failures parsed" >> test_summary.md
          fi
          
          cat test_summary.md
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            TestResults.xcresult
            UITestResults.xcresult
            test.log
            ui_test.log
            test_summary.md
          retention-days: 30
