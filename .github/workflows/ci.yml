name: CI - Build & Test

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  test:
    runs-on: macos-15
    timeout-minutes: 30  # Prevent entire job from hanging
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 1
      
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
      
      - name: Show Available Simulators (Before)
        run: |
          echo "=== Xcode Version ==="
          xcodebuild -version
          echo ""
          echo "=== Available iOS Simulators (Before Runtime Install) ==="
          xcrun simctl list devices available iOS
      
      - name: Install iOS 18 Runtime
        run: |
          set -x  # Verbose logging
          echo "ðŸ” Checking current runtimes..."
          xcrun simctl list runtimes
          
          echo ""
          echo "ðŸ” Checking available devices BEFORE install..."
          xcrun simctl list devices available
          
          # Check if iOS 18 runtime already exists
          if xcrun simctl list runtimes | grep -q "iOS 18"; then
            echo "âœ… iOS 18 runtime already installed!"
            
            # Verify iPhone 16 Pro is available
            if xcrun simctl list devices available | grep -q "iPhone 16 Pro"; then
              echo "âœ… iPhone 16 Pro simulator already available!"
              exit 0
            fi
          fi
          
          echo ""
          echo "ðŸ“¥ iOS 18 runtime not found, downloading..."
          echo "âš ï¸ This may take 20-40 minutes and download 10+ GB"
          echo "â° Started at: $(date)"
          
          # Download iOS runtime WITHOUT bash timeout
          sudo xcodebuild -downloadPlatform iOS 2>&1 | tee download.log
          DOWNLOAD_EXIT=$?
          
          echo ""
          echo "â° Finished at: $(date)"
          echo "Exit code: $DOWNLOAD_EXIT"
          
          if [ $DOWNLOAD_EXIT -ne 0 ]; then
            echo "âŒ Download failed with exit code: $DOWNLOAD_EXIT"
            exit $DOWNLOAD_EXIT
          fi
          
          echo "âœ… Download command completed!"
          
          echo ""
          echo "ðŸ” Verifying runtimes AFTER download..."
          xcrun simctl list runtimes
          
          echo ""
          echo "ðŸ” Checking devices AFTER install..."
          xcrun simctl list devices available
          
          # Verify iOS 18 is installed
          if ! xcrun simctl list runtimes | grep -q "iOS 18"; then
            echo "âŒ iOS 18 runtime STILL not found!"
            exit 1
          fi
          
          # Verify iPhone 16 Pro exists
          if ! xcrun simctl list devices available | grep -q "iPhone 16 Pro"; then
            echo "âŒ iPhone 16 Pro not found!"
            echo "Available iPhones:"
            xcrun simctl list devices available | grep "iPhone"
            exit 1
          fi
          
          echo "âœ… iOS 18 runtime and iPhone 16 Pro verified!"
        timeout-minutes: 60
      
      - name: Show Available Simulators (After)
        run: |
          echo "=== Available iOS Simulators (After Runtime Install) ==="
          xcrun simctl list devices available iOS
          echo ""
          echo "=== All Installed Runtimes ==="
          xcrun simctl list runtimes
      
      - name: Install SwiftLint
        run: |
          if ! command -v swiftlint &> /dev/null; then
            echo "Installing SwiftLint..."
            brew install swiftlint
          else
            echo "SwiftLint already installed: $(swiftlint version)"
          fi
      
      - name: Run SwiftLint
        run: |
          cd SequenceGame
          swiftlint lint --strict || echo "âš ï¸ SwiftLint found issues, but continuing..."
        continue-on-error: true
      
      - name: Boot Simulator
        run: |
          # Find an available iPhone simulator (prefer iPhone 16 Pro if available)
          SIMULATOR_ID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro \(" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')
          
          if [ -z "$SIMULATOR_ID" ]; then
            echo "iPhone 16 Pro not found, using any available iPhone..."
            SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')
          fi
          
          if [ -z "$SIMULATOR_ID" ]; then
            echo "âŒ No iPhone simulators found!"
            exit 1
          fi
          
          echo "ðŸ“± Booting simulator: $SIMULATOR_ID"
          xcrun simctl boot "$SIMULATOR_ID" || echo "Simulator already booted or boot failed, continuing..."
          
          # Wait for simulator to be fully booted
          echo "â³ Waiting for simulator to boot..."
          xcrun simctl bootstatus "$SIMULATOR_ID" -b || true
          
          echo "âœ… Simulator ready!"
      
      - name: Build for Testing
        run: |
          set -o pipefail
          xcodebuild clean build-for-testing \
            -project SequenceGame/SequenceGame.xcodeproj \
            -scheme SequenceGame \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty || cat xcodebuild.log
        timeout-minutes: 10
      
      - name: Run Unit Tests
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project SequenceGame/SequenceGame.xcodeproj \
            -scheme SequenceGame \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
            -only-testing:SequenceGameTests \
            -resultBundlePath TestResults.xcresult \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | tee test.log | xcpretty || cat test.log
        timeout-minutes: 10
      
      - name: Run UI Tests
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project SequenceGame/SequenceGame.xcodeproj \
            -scheme SequenceGame \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
            -only-testing:SequenceGameUITests \
            -resultBundlePath UITestResults.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | tee ui_test.log | xcpretty || cat ui_test.log
        timeout-minutes: 15
        continue-on-error: true  # UI tests can be flaky in CI
      
      - name: Parse Test Results
        if: failure()
        run: |
          echo "## Test Failure Summary" > test_summary.md
          echo "" >> test_summary.md
          
          if [ -f test.log ]; then
            echo "### Unit Test Failures:" >> test_summary.md
            grep -E "error:|failed|Test Case.*failed" test.log | head -20 >> test_summary.md || echo "No unit test failures parsed" >> test_summary.md
          fi
          
          if [ -f ui_test.log ]; then
            echo "" >> test_summary.md
            echo "### UI Test Failures:" >> test_summary.md
            grep -E "error:|failed|Test Case.*failed" ui_test.log | head -20 >> test_summary.md || echo "No UI test failures parsed" >> test_summary.md
          fi
          
          cat test_summary.md
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            TestResults.xcresult
            UITestResults.xcresult
            test.log
            ui_test.log
            test_summary.md
          retention-days: 30
