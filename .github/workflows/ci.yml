name: CI - Tests & Lint

on:
  push:
    branches:
      - '**'  # Run on all branches
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  test-and-lint:
    name: Run Tests & SwiftLint
    runs-on: macos-15  # Latest macOS with Xcode
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true  # Ensure clean checkout
          fetch-depth: 1  # Shallow clone for speed
      
      - name: Diagnose project file
        run: |
          echo "üìã Checking project.pbxproj file..."
          
          # Check file encoding
          file SequenceGame/SequenceGame.xcodeproj/project.pbxproj
          
          # Check for common issues
          echo ""
          echo "üîç Searching for potential issues..."
          
          # Check for merge conflicts
          if grep -q "<<<<<<< HEAD" SequenceGame/SequenceGame.xcodeproj/project.pbxproj; then
            echo "‚ùå Found merge conflict markers"
            grep -n "<<<<<<< HEAD\|=======\|>>>>>>>" SequenceGame/SequenceGame.xcodeproj/project.pbxproj
            exit 1
          fi
          
          # Check for invalid characters or encoding issues
          if ! grep -q "isa = PBXProject" SequenceGame/SequenceGame.xcodeproj/project.pbxproj; then
            echo "‚ùå Cannot find 'isa = PBXProject' - file may be corrupted"
            exit 1
          fi
          
          echo "‚úÖ Basic checks passed"
          
          # Try to list schemes (this is where it fails)
          echo ""
          echo "üìã Attempting to list schemes..."
          if xcodebuild -project SequenceGame/SequenceGame.xcodeproj -list; then
            echo "‚úÖ Successfully listed schemes"
          else
            echo "‚ùå Failed to list schemes"
            echo ""
            echo "üîç Showing first 100 lines of project.pbxproj for inspection:"
            head -100 SequenceGame/SequenceGame.xcodeproj/project.pbxproj
            exit 1
          fi
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Install SwiftLint
        run: brew install swiftlint
      
      - name: Run SwiftLint
        run: |
          swiftlint lint --reporter github-actions-logging
          # Fail if there are errors (warnings are allowed)
          swiftlint lint --strict --quiet
      
      - name: Build for testing
        run: |
          xcodebuild clean build-for-testing \
            -project SequenceGame/SequenceGame.xcodeproj \
            -scheme SequenceGame \
            -destination 'platform=iOS Simulator,name=any iOS Simulator' \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Run tests
        id: run_tests
        run: |
          set +e  # Don't exit on error, we want to capture the output
          
          xcodebuild test-without-building \
            -project SequenceGame/SequenceGame.xcodeproj \
            -scheme SequenceGame \
            -destination 'platform=iOS Simulator,name=any iOS Simulator' \
            -derivedDataPath DerivedData \
            -resultBundlePath TestResults.xcresult \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            2>&1 | tee test-output.log
          
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          
          exit $TEST_EXIT_CODE
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.sha }}
          path: |
            TestResults.xcresult
            test-output.log
          retention-days: 30
      
      - name: Parse test failures
        if: failure() && steps.run_tests.outcome == 'failure'
        id: parse_results
        run: |
          echo "## üî¥ Test Failures Report" > test_report.md
          echo "" >> test_report.md
          echo "**Build**: #${{ github.run_number }}" >> test_report.md
          echo "**Commit**: \`${{ github.sha }}\`" >> test_report.md
          echo "**Branch**: \`${{ github.ref_name }}\`" >> test_report.md
          echo "**Triggered by**: @${{ github.actor }}" >> test_report.md
          echo "" >> test_report.md
          echo "---" >> test_report.md
          echo "" >> test_report.md
          
          # Extract test failures from log
          echo "### ‚ùå Failed Tests:" >> test_report.md
          echo "" >> test_report.md
          echo '```' >> test_report.md
          grep -A 3 "Test Case.*failed" test-output.log | head -100 >> test_report.md || echo "Could not parse specific test failures" >> test_report.md
          echo '```' >> test_report.md
          echo "" >> test_report.md
          
          # Add error details
          echo "### üìã Error Details:" >> test_report.md
          echo "" >> test_report.md
          echo '```' >> test_report.md
          grep -E "(error:|failed|assertion|Fatal error)" test-output.log | head -50 >> test_report.md || echo "No specific errors found in log" >> test_report.md
          echo '```' >> test_report.md
          echo "" >> test_report.md
          
          # Add action items
          echo "### üéØ Action Items:" >> test_report.md
          echo "" >> test_report.md
          echo "- [ ] Review failed test cases above" >> test_report.md
          echo "- [ ] Reproduce failure locally" >> test_report.md
          echo "- [ ] Fix the failing tests" >> test_report.md
          echo "- [ ] Verify fix with local testing" >> test_report.md
          echo "- [ ] Push fix and verify CI passes" >> test_report.md
          echo "" >> test_report.md
          
          # Add links
          echo "### üìé Useful Links:" >> test_report.md
          echo "" >> test_report.md
          echo "- [Failed Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> test_report.md
          echo "- [Commit with Failure](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> test_report.md
          echo "- Download artifacts from the workflow run above to get full test results" >> test_report.md
          echo "" >> test_report.md
          
          # Create issue title
          FAILED_TEST_COUNT=$(grep -c "Test Case.*failed" test-output.log || echo "Unknown")
          echo "title=üö® CI Test Failure: $FAILED_TEST_COUNT test(s) failed on ${{ github.ref_name }}" >> $GITHUB_OUTPUT
          
          cat test_report.md
      
      - name: Create GitHub Issue on Test Failure
        if: failure() && steps.run_tests.outcome == 'failure' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const issueBody = fs.readFileSync('test_report.md', 'utf8');
            
            // Check if an issue already exists for this run
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure',
              per_page: 20
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('CI Test Failure') && 
              issue.created_at > new Date(Date.now() - 3600000).toISOString() // Within last hour
            );
            
            if (existingIssue) {
              // Update existing issue with new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `### üîÑ Test failure occurred again\n\n${issueBody}`
              });
              
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '${{ steps.parse_results.outputs.title }}',
                body: issueBody,
                labels: ['bug', 'ci-failure', 'priority-1', 'auto-generated']
              });
              
              console.log(`Created issue #${issue.data.number}`);
            }
