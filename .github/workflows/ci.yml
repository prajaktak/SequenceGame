name: CI - Build & Test

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  build-and-test:
    name: Build and Test iOS App
    runs-on: macos-15
    timeout-minutes: 30
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
        
      - name: Verify Xcode Version
        run: |
          echo "=== Xcode Version ==="
          xcodebuild -version
          echo ""
          echo "=== Xcode Path ==="
          xcode-select -p
      
      - name: List Available Simulators
        run: |
          echo "=== All Available iOS Simulators ==="
          xcrun simctl list devices available iOS
          echo ""
          echo "=== iOS Runtimes ==="
          xcrun simctl list runtimes iOS
      
      - name: Boot Simulator and Get UUID
        id: simulator
        run: |
          echo "=== Finding and Booting Simulator ==="
          
          # Get simctl output
          SIMCTL_OUTPUT=$(xcrun simctl list devices available iOS)
          
          # Find first iPhone 16 (non-Pro) with iOS 18.4+
          DEVICE_LINE=$(echo "$SIMCTL_OUTPUT" | grep -A 20 "-- iOS 18.4 --" | grep "iPhone 16" | grep -v "Pro\|Plus\|Max\|e" | head -n 1)
          
          if [ -z "$DEVICE_LINE" ]; then
            # Try any iPhone 16
            DEVICE_LINE=$(echo "$SIMCTL_OUTPUT" | grep "iPhone 16" | head -n 1)
          fi
          
          if [ -z "$DEVICE_LINE" ]; then
            # Try iPhone 15
            DEVICE_LINE=$(echo "$SIMCTL_OUTPUT" | grep "iPhone 15" | head -n 1)
          fi
          
          if [ -z "$DEVICE_LINE" ]; then
            echo "❌ ERROR: No iPhone simulator found!"
            exit 1
          fi
          
          # Extract UUID
          SIMULATOR_UUID=$(echo "$DEVICE_LINE" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
          
          if [ -z "$SIMULATOR_UUID" ]; then
            echo "❌ ERROR: Could not extract simulator UUID"
            exit 1
          fi
          
          echo "✅ Found Simulator UUID: $SIMULATOR_UUID"
          
          # Boot the simulator
          echo "Booting simulator..."
          xcrun simctl boot "$SIMULATOR_UUID" 2>&1 || echo "Simulator may already be booted"
          
          # Wait for simulator to be ready
          sleep 10
          
          # Verify it's booted
          BOOT_STATUS=$(xcrun simctl list devices | grep "$SIMULATOR_UUID" | grep -o "(Booted)" || echo "")
          if [ -n "$BOOT_STATUS" ]; then
            echo "✅ Simulator is booted and ready"
          else
            echo "⚠️  Simulator boot status unclear, continuing anyway"
          fi
          
          echo "uuid=$SIMULATOR_UUID" >> $GITHUB_OUTPUT
          echo "destination=platform=iOS Simulator,id=$SIMULATOR_UUID" >> $GITHUB_OUTPUT
      
      - name: Build Project
        run: |
          echo "=== Building Project ==="
          echo "Using destination: ${{ steps.simulator.outputs.destination }}"
          xcodebuild clean build \
            -project SequenceGame/SequenceGame.xcodeproj \
            -scheme SequenceGame \
            -sdk iphonesimulator \
            -destination '${{ steps.simulator.outputs.destination }}' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -derivedDataPath DerivedData
          
          echo "✅ Build successful!"
      
      - name: Run Tests
        run: |
          echo "=== Running Tests ==="
          echo "Using destination: ${{ steps.simulator.outputs.destination }}"
          xcodebuild test \
            -project SequenceGame/SequenceGame.xcodeproj \
            -scheme SequenceGame \
            -sdk iphonesimulator \
            -destination '${{ steps.simulator.outputs.destination }}' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -derivedDataPath DerivedData \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            | tee test-output.log
          
          echo "✅ Tests completed!"
      
      - name: Check Test Results
        if: always()
        run: |
          if grep -q "Test Suite.*failed" test-output.log; then
            echo "❌ Tests failed"
            exit 1
          fi
          echo "✅ All tests passed"
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.sha }}
          path: |
            TestResults.xcresult
            test-output.log
            DerivedData/Logs/Test/*.xcresult
