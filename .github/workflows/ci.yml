name: CI - Tests & Lint

on:
  push:
    branches:
      - '**'  # Run on all branches
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  test-and-lint:
    name: Run Tests & SwiftLint
    runs-on: macos-14  # Latest macOS with Xcode
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” DEBUG - Show project structure  # ADD THIS
        run: |
          echo "=== Repository Structure ==="
          ls -la
          echo ""
          echo "=== Looking for .xcodeproj files ==="
          find . -name "*.xcodeproj" -maxdepth 3
          echo ""
          echo "=== Looking for .xcworkspace files ==="
          find . -name "*.xcworkspace" -maxdepth 3
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Install SwiftLint
        run: brew install swiftlint
      
      - name: Run SwiftLint
        run: |
          swiftlint lint --reporter github-actions-logging
          # Fail if there are errors (warnings are allowed)
          swiftlint lint --strict --quiet
      
      - name: Build for testing
        run: |
          # Find the .xcodeproj file
          PROJECT_PATH=$(find . -name "*.xcodeproj" -maxdepth 2 | head -1)
          if [ -z "$PROJECT_PATH" ]; then
            echo "Error: No Xcode project found"
            exit 1
          fi
          echo "Found project at: $PROJECT_PATH"
          
          xcodebuild clean build-for-testing \
            -project "$PROJECT_PATH" \
            -scheme SequenceGame \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
            -derivedDataPath DerivedData
      
      - name: Run tests
        id: run_tests
        run: |
          set +e  # Don't exit on error, we want to capture the output
          
          # Find the .xcodeproj file
          PROJECT_PATH=$(find . -name "*.xcodeproj" -maxdepth 2 | head -1)
          
          xcodebuild test-without-building \
            -project "$PROJECT_PATH" \
            -scheme SequenceGame \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
            -derivedDataPath DerivedData \
            -resultBundlePath TestResults.xcresult \
            -enableCodeCoverage YES \
            2>&1 | tee test-output.log
          
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          
          exit $TEST_EXIT_CODE
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.sha }}
          path: |
            TestResults.xcresult
            test-output.log
          retention-days: 30
      
      - name: Parse test failures
        if: failure() && steps.run_tests.outcome == 'failure'
        id: parse_results
        run: |
          echo "## ðŸ”´ Test Failures Report" > test_report.md
          echo "" >> test_report.md
          echo "**Build**: #${{ github.run_number }}" >> test_report.md
          echo "**Commit**: \`${{ github.sha }}\`" >> test_report.md
          echo "**Branch**: \`${{ github.ref_name }}\`" >> test_report.md
          echo "**Triggered by**: @${{ github.actor }}" >> test_report.md
          echo "" >> test_report.md
          echo "---" >> test_report.md
          echo "" >> test_report.md
          
          # Extract test failures from log
          echo "### âŒ Failed Tests:" >> test_report.md
          echo "" >> test_report.md
          echo '```' >> test_report.md
          grep -A 3 "Test Case.*failed" test-output.log | head -100 >> test_report.md || echo "Could not parse specific test failures" >> test_report.md
          echo '```' >> test_report.md
          echo "" >> test_report.md
          
          # Add error details
          echo "### ðŸ“‹ Error Details:" >> test_report.md
          echo "" >> test_report.md
          echo '```' >> test_report.md
          grep -E "(error:|failed|assertion|Fatal error)" test-output.log | head -50 >> test_report.md || echo "No specific errors found in log" >> test_report.md
          echo '```' >> test_report.md
          echo "" >> test_report.md
          
          # Add action items
          echo "### ðŸŽ¯ Action Items:" >> test_report.md
          echo "" >> test_report.md
          echo "- [ ] Review failed test cases above" >> test_report.md
          echo "- [ ] Reproduce failure locally" >> test_report.md
          echo "- [ ] Fix the failing tests" >> test_report.md
          echo "- [ ] Verify fix with local testing" >> test_report.md
          echo "- [ ] Push fix and verify CI passes" >> test_report.md
          echo "" >> test_report.md
          
          # Add links
          echo "### ðŸ“Ž Useful Links:" >> test_report.md
          echo "" >> test_report.md
          echo "- [Failed Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> test_report.md
          echo "- [Commit with Failure](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> test_report.md
          echo "- Download artifacts from the workflow run above to get full test results" >> test_report.md
          echo "" >> test_report.md
          
          # Create issue title
          FAILED_TEST_COUNT=$(grep -c "Test Case.*failed" test-output.log || echo "Unknown")
          echo "title=ðŸš¨ CI Test Failure: $FAILED_TEST_COUNT test(s) failed on ${{ github.ref_name }}" >> $GITHUB_OUTPUT
          
          cat test_report.md
      
      - name: Create GitHub Issue on Test Failure
        if: failure() && steps.run_tests.outcome == 'failure' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const issueBody = fs.readFileSync('test_report.md', 'utf8');
            
            // Check if an issue already exists for this run
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure',
              per_page: 20
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('CI Test Failure') && 
              issue.created_at > new Date(Date.now() - 3600000).toISOString() // Within last hour
            );
            
            if (existingIssue) {
              // Update existing issue with new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `### ðŸ”„ Test failure occurred again\n\n${issueBody}`
              });
              
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '${{ steps.parse_results.outputs.title }}',
                body: issueBody,
                labels: ['bug', 'ci-failure', 'priority-1', 'auto-generated']
              });
              
              console.log(`Created issue #${issue.data.number}`);
            }
