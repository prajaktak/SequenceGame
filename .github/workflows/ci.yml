name: CI - Build & Test

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Build and Test
    runs-on: macos-15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Select Xcode 16.1
        run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
      
      - name: Build and Test
        run: |
          xcodebuild clean test -project SequenceGame/SequenceGame.xcodeproj -scheme SequenceGame -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | tee xcodebuild.log \
            | xcbeautify --is-ci
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            TestResults.xcresult
            xcodebuild.log
          retention-days: 30
      
      - name: Parse test failures
        if: failure()
        id: parse_results
        run: |
          echo "## ðŸ”´ Test Failures Report" > test_report.md
          echo "" >> test_report.md
          echo "**Build**: #${{ github.run_number }}" >> test_report.md
          echo "**Commit**: \`${{ github.sha }}\`" >> test_report.md
          echo "**Branch**: \`${{ github.ref_name }}\`" >> test_report.md
          echo "**Triggered by**: @${{ github.actor }}" >> test_report.md
          echo "" >> test_report.md
          echo "---" >> test_report.md
          echo "" >> test_report.md
          
          echo "### âŒ Failed Tests:" >> test_report.md
          echo "" >> test_report.md
          echo '```' >> test_report.md
          grep "Test Case.*failed" xcodebuild.log | head -50 >> test_report.md || echo "Could not parse test failures" >> test_report.md
          echo '```' >> test_report.md
          echo "" >> test_report.md
          
          echo "### ðŸ“‹ Error Details:" >> test_report.md
          echo "" >> test_report.md
          echo '```' >> test_report.md
          grep -E "(error:|failed|assertion)" xcodebuild.log | head -50 >> test_report.md || echo "No errors found" >> test_report.md
          echo '```' >> test_report.md
          echo "" >> test_report.md
          
          echo "### ðŸŽ¯ Action Items:" >> test_report.md
          echo "" >> test_report.md
          echo "- [ ] Review failed test cases above" >> test_report.md
          echo "- [ ] Reproduce failure locally" >> test_report.md
          echo "- [ ] Fix the failing tests" >> test_report.md
          echo "- [ ] Push fix and verify CI passes" >> test_report.md
          echo "" >> test_report.md
          
          echo "### ðŸ“Ž Links:" >> test_report.md
          echo "" >> test_report.md
          echo "- [Failed Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> test_report.md
          echo "- [Commit](${{ github.event.head_commit.url }})" >> test_report.md
          echo "" >> test_report.md
          
          FAILED_COUNT=$(grep -c "Test Case.*failed" xcodebuild.log || echo "Unknown")
          echo "title=ðŸš¨ CI: $FAILED_COUNT test(s) failed on ${{ github.ref_name }}" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Issue on Failure
        if: failure() && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issueBody = fs.readFileSync('test_report.md', 'utf8');
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure',
              per_page: 10
            });
            
            const recentIssue = issues.data.find(issue => 
              issue.title.includes('CI:') && 
              new Date(issue.created_at) > new Date(Date.now() - 3600000)
            );
            
            if (recentIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentIssue.number,
                body: `### ðŸ”„ Failed again\n\n${issueBody}`
              });
              console.log(`Updated issue #${recentIssue.number}`);
            } else {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '${{ steps.parse_results.outputs.title }}',
                body: issueBody,
                labels: ['bug', 'ci-failure', 'priority-1']
              });
              console.log(`Created issue #${issue.data.number}`);
            }

