name: CI - Build & Test

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  build-and-test:
    name: Build and Test iOS App
    runs-on: macos-15
    timeout-minutes: 30
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
        
      - name: Verify Xcode Version
        run: |
          echo "=== Xcode Version ==="
          xcodebuild -version
          echo ""
          echo "=== Xcode Path ==="
          xcode-select -p
      
      - name: List Available Simulators
        run: |
          echo "=== All Available iOS Simulators ==="
          xcrun simctl list devices available iOS
          echo ""
          echo "=== iOS Runtimes ==="
          xcrun simctl list runtimes iOS
      
      - name: Show Valid Destinations
        id: destinations
        run: |
          echo "=== Valid xcodebuild Destinations ==="
          xcodebuild -showdestinations \
            -project SequenceGame/SequenceGame.xcodeproj \
            -scheme SequenceGame 2>&1 | tee destinations.log
          echo ""
          echo "=== iOS Simulator Destinations ==="
          grep -i "iOS Simulator" destinations.log || echo "No iOS Simulator destinations found"
      
      - name: Discover and Select Simulator
        id: simulator
        run: |
          echo "=== Finding Best Available Simulator ==="
          
          # Get full simctl output for parsing
          SIMCTL_OUTPUT=$(xcrun simctl list devices available iOS)
          
          # First, try to get a valid destination from -showdestinations output
          if [ -f destinations.log ]; then
            # Extract first iOS Simulator destination
            DEST_LINE=$(grep -i "iOS Simulator" destinations.log | head -n 1)
            
            if [ -n "$DEST_LINE" ]; then
              # Try to extract name and OS from the destination line
              # Format: { platform:iOS Simulator, id:..., OS:..., name:... }
              SIM_NAME=$(echo "$DEST_LINE" | grep -oE 'name:[^,}]+' | head -1 | sed 's/name://' | xargs)
              OS_VER=$(echo "$DEST_LINE" | grep -oE 'OS:[^,}]+' | head -1 | sed 's/OS://' | xargs)
              
              if [ -n "$SIM_NAME" ] && [ -n "$OS_VER" ]; then
                DESTINATION="platform=iOS Simulator,name=$SIM_NAME,OS=$OS_VER"
                echo "✅ Found destination from -showdestinations: $DESTINATION"
                echo "destination=$DESTINATION" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
          fi
          
          # Fallback: Use simctl to find available iPhone simulators
          echo "Using simctl fallback method..."
          
          # Try iPhone 16 (any variant) - get the first match
          DEVICE_LINE=$(echo "$SIMCTL_OUTPUT" | grep "iPhone 16" | grep -v "Pro\|Plus\|Max\|e" | head -n 1)
          
          if [ -z "$DEVICE_LINE" ]; then
            # Try iPhone 16 Pro
            DEVICE_LINE=$(echo "$SIMCTL_OUTPUT" | grep "iPhone 16 Pro" | head -n 1)
          fi
          
          if [ -z "$DEVICE_LINE" ]; then
            # Try iPhone 15
            DEVICE_LINE=$(echo "$SIMCTL_OUTPUT" | grep "iPhone 15" | head -n 1)
          fi
          
          if [ -z "$DEVICE_LINE" ]; then
            # Try iPhone 14
            DEVICE_LINE=$(echo "$SIMCTL_OUTPUT" | grep "iPhone 14" | head -n 1)
          fi
          
          if [ -z "$DEVICE_LINE" ]; then
            # Try any iPhone
            DEVICE_LINE=$(echo "$SIMCTL_OUTPUT" | grep "iPhone" | head -n 1)
          fi
          
          if [ -z "$DEVICE_LINE" ]; then
            echo "❌ ERROR: No iPhone simulator found!"
            echo "Available devices:"
            echo "$SIMCTL_OUTPUT"
            exit 1
          fi
          
          # Extract device name (e.g., "iPhone 16")
          SIMULATOR=$(echo "$DEVICE_LINE" | sed -E 's/^[[:space:]]+(iPhone [^ ]+).*/\1/' | xargs)
          
          # Find the OS version by looking backwards from the device line
          # The format is: "-- iOS 18.4 --" followed by device listings
          # Find the line number of the device
          DEVICE_LINE_NUM=$(echo "$SIMCTL_OUTPUT" | grep -n "$DEVICE_LINE" | head -1 | cut -d: -f1)
          
          # Get all lines before the device line, find the last iOS version header
          OS_VERSION=$(echo "$SIMCTL_OUTPUT" | head -n "$DEVICE_LINE_NUM" | grep -E '^-- iOS [0-9]+\.[0-9]+ --' | tail -1 | sed -E 's/-- iOS ([0-9]+\.[0-9]+) --/\1/')
          
          if [ -z "$OS_VERSION" ]; then
            echo "⚠️  Warning: Could not extract OS version from simctl, trying runtimes"
            # Get first available iOS runtime version as fallback
            OS_VERSION=$(xcrun simctl list runtimes iOS | grep "iOS" | head -1 | sed -E 's/.*iOS ([0-9]+\.[0-9]+).*/\1/')
          fi
          
          if [ -z "$OS_VERSION" ]; then
            echo "❌ ERROR: Could not determine OS version for simulator"
            echo "Device line: $DEVICE_LINE"
            echo "Device line number: $DEVICE_LINE_NUM"
            exit 1
          fi
          
          DESTINATION="platform=iOS Simulator,name=$SIMULATOR,OS=$OS_VERSION"
          
          echo "✅ Selected Simulator: $SIMULATOR"
          echo "✅ Selected OS Version: $OS_VERSION"
          echo "✅ Using Destination: $DESTINATION"
          echo "destination=$DESTINATION" >> $GITHUB_OUTPUT
      
      - name: Build Project
        run: |
          echo "=== Building Project ==="
          echo "Using destination: ${{ steps.simulator.outputs.destination }}"
          xcodebuild clean build \
            -project SequenceGame/SequenceGame.xcodeproj \
            -scheme SequenceGame \
            -destination '${{ steps.simulator.outputs.destination }}' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -derivedDataPath DerivedData
          
          echo "✅ Build successful!"
      
      - name: Run Tests
        run: |
          echo "=== Running Tests ==="
          echo "Using destination: ${{ steps.simulator.outputs.destination }}"
          xcodebuild test \
            -project SequenceGame/SequenceGame.xcodeproj \
            -scheme SequenceGame \
            -destination '${{ steps.simulator.outputs.destination }}' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -derivedDataPath DerivedData \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            | tee test-output.log
          
          echo "✅ Tests completed!"
      
      - name: Check Test Results
        if: always()
        run: |
          if grep -q "Test Suite.*failed" test-output.log; then
            echo "❌ Tests failed"
            exit 1
          fi
          echo "✅ All tests passed"
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.sha }}
          path: |
            TestResults.xcresult
            test-output.log
            DerivedData/Logs/Test/*.xcresult
